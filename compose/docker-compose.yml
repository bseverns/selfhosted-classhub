services:
  caddy:
    image: caddy:2
    container_name: classhub_caddy
    restart: unless-stopped
    ports: ["80:80", "443:443"]
    env_file: [.env]
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - classhub_web
      - helper_web

  postgres:
    image: postgres:16
    container_name: classhub_postgres
    restart: unless-stopped
    env_file: [.env]
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - ../data/postgres:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 10

  redis:
    image: redis:7
    container_name: classhub_redis
    restart: unless-stopped
    command: ["redis-server", "--save", "60", "1", "--loglevel", "warning"]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 10

  ollama:
    image: ollama/ollama:latest
    container_name: classhub_ollama
    restart: unless-stopped
    ports:
      - "11434:11434"
    volumes:
      - ../data/ollama:/root/.ollama

  minio:
    image: minio/minio:latest
    container_name: classhub_minio
    restart: unless-stopped
    env_file: [.env]
    command: server /data --console-address ":9001"
    ports:
      - "9001:9001" # Day-1 convenience; remove or firewall later
    volumes:
      - ../data/minio:/data

  classhub_web:
    build:
      context: ../services
      dockerfile: classhub/Dockerfile
    container_name: classhub_web
    restart: unless-stopped
    env_file: [.env]
    environment:
      DATABASE_URL: postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
      REDIS_URL: redis://redis:6379/0
      S3_ENDPOINT: http://minio:9000
      S3_ACCESS_KEY: ${MINIO_ROOT_USER}
      S3_SECRET_KEY: ${MINIO_ROOT_PASSWORD}
      DJANGO_ALLOWED_HOSTS: ${DJANGO_ALLOWED_HOSTS}
      DJANGO_SECRET_KEY: ${DJANGO_SECRET_KEY}
      DJANGO_DEBUG: ${DJANGO_DEBUG}
      CSRF_TRUSTED_ORIGINS: ${CSRF_TRUSTED_ORIGINS}
      CLASSHUB_UPLOAD_ROOT: /uploads
    volumes:
      - ../data/classhub_uploads:/uploads
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  helper_web:
    build:
      context: ../services
      dockerfile: homework_helper/Dockerfile
    container_name: helper_web
    restart: unless-stopped
    env_file: [.env]
    environment:
      DATABASE_URL: postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
      REDIS_URL: redis://redis:6379/1
      HELPER_LLM_BACKEND: ${HELPER_LLM_BACKEND}
      HELPER_STRICTNESS: ${HELPER_STRICTNESS}
      HELPER_SCOPE_MODE: ${HELPER_SCOPE_MODE}
      HELPER_REFERENCE_DIR: ${HELPER_REFERENCE_DIR}
      HELPER_REFERENCE_MAP: ${HELPER_REFERENCE_MAP}
      HELPER_REFERENCE_FILE: ${HELPER_REFERENCE_FILE}
      HELPER_MAX_CONCURRENCY: ${HELPER_MAX_CONCURRENCY}
      HELPER_QUEUE_MAX_WAIT_SECONDS: ${HELPER_QUEUE_MAX_WAIT_SECONDS}
      HELPER_QUEUE_POLL_SECONDS: ${HELPER_QUEUE_POLL_SECONDS}
      HELPER_QUEUE_SLOT_TTL_SECONDS: ${HELPER_QUEUE_SLOT_TTL_SECONDS}
      OLLAMA_BASE_URL: ${OLLAMA_BASE_URL}
      OLLAMA_MODEL: ${OLLAMA_MODEL}
      OLLAMA_TIMEOUT_SECONDS: ${OLLAMA_TIMEOUT_SECONDS}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      OPENAI_MODEL: ${OPENAI_MODEL}
      DJANGO_ALLOWED_HOSTS: ${DJANGO_ALLOWED_HOSTS}
      DJANGO_SECRET_KEY: ${DJANGO_SECRET_KEY}
      DJANGO_DEBUG: ${DJANGO_DEBUG}
      CSRF_TRUSTED_ORIGINS: ${CSRF_TRUSTED_ORIGINS}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      ollama:
        condition: service_started

volumes:
  caddy_data:
  caddy_config:
