<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Teacher · {{ classroom.name }}</title>
    {% include "includes/glass_theme.html" %}
    <style>
      .mini { font-size: 13px; }
      .top h1 { margin: 6px 0 0 0; font-size: clamp(1.85rem, 2.6vw, 2.35rem); }
      .btnline form { display: inline-block; margin: 0 6px 0 0; }
      .btnline button { padding: 8px 10px; font-size: 13px; border-radius: 10px; }
      .quick { margin-top: 12px; margin-right: 8px; margin-bottom: 6px; }
      .module {
        border: 1px solid rgba(22, 59, 80, 0.14);
        border-radius: 14px;
        padding: 16px;
        margin-top: 16px;
        background: rgba(255, 255, 255, 0.42);
      }
      .mat {
        margin-top: 12px;
        padding: 12px;
        border-radius: 12px;
        border: 1px solid rgba(22, 59, 80, 0.12);
        background: rgba(255, 255, 255, 0.5);
      }
      .actions a { margin-right: 8px; font-size: 13px; }
      .lesson-table-wrap {
        margin-top: 12px;
        border: 1px solid rgba(22, 59, 80, 0.16);
        border-radius: 14px;
        overflow: auto;
        background: rgba(255, 255, 255, 0.42);
      }
      .lesson-table-wrap table {
        margin: 0;
        min-width: 980px;
      }
      .lesson-table-wrap thead th {
        position: sticky;
        top: 0;
        z-index: 2;
        background: rgba(237, 246, 251, 0.96);
        backdrop-filter: blur(5px);
      }
      .lesson-table-wrap tbody td {
        border-bottom-color: rgba(22, 59, 80, 0.12);
      }
      .lesson-table-wrap tbody tr:last-child td {
        border-bottom: 0;
      }
      .lesson-row td {
        background: rgba(255, 255, 255, 0.2);
      }
      .lesson-row:nth-child(even) td {
        background: rgba(255, 255, 255, 0.34);
      }
      .module-cell {
        min-width: 200px;
      }
      .lesson-cell {
        min-width: 360px;
      }
      .dropbox-cell {
        min-width: 300px;
      }
      .dropbox {
        margin: 0 0 16px 0;
        padding: 12px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.4);
        border: 1px solid rgba(22, 59, 80, 0.12);
      }
      .dropbox:last-child {
        margin-bottom: 0;
      }
      .teacher-note {
        margin-top: 14px;
        padding: 12px;
        border-radius: 12px;
        border: 1px solid rgba(22, 59, 80, 0.14);
        background: rgba(255, 255, 255, 0.42);
      }
      .teacher-note summary {
        cursor: pointer;
        font-weight: 700;
        color: #1b4258;
      }
      .teacher-note-body {
        margin-top: 8px;
      }
      .release-box {
        margin-top: 14px;
        padding: 12px;
        border-radius: 12px;
        border: 1px solid rgba(22, 59, 80, 0.14);
        background: rgba(255, 255, 255, 0.42);
      }
      .release-status {
        font-size: 13px;
        margin-bottom: 8px;
      }
      .release-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
        margin-top: 6px;
      }
      .release-actions form {
        margin: 0;
      }
      .release-actions input[type="date"] {
        width: auto;
        min-width: 165px;
      }
      .notice {
        border: 1px solid rgba(36, 128, 66, 0.25);
        background: rgba(224, 248, 229, 0.75);
        color: #215a2f;
        border-radius: 12px;
        padding: 10px;
      }
      .error {
        border: 1px solid rgba(182, 56, 56, 0.35);
        background: rgba(255, 224, 224, 0.58);
        color: #8f2d2d;
        border-radius: 12px;
        padding: 10px;
      }
      .inline-copy {
        margin-left: 8px;
        padding: 4px 8px;
        border-radius: 9px;
        font-size: 12px;
      }
      .copy-status {
        margin-top: 8px;
        min-height: 18px;
      }
      .roster-table-wrap {
        margin-top: 12px;
        border: 1px solid rgba(22, 59, 80, 0.16);
        border-radius: 14px;
        overflow: auto;
        background: rgba(255, 255, 255, 0.42);
      }
      .roster-table-wrap table {
        margin: 0;
        min-width: 760px;
      }
      .roster-table-wrap thead th {
        position: sticky;
        top: 0;
        z-index: 2;
        background: rgba(237, 246, 251, 0.96);
        backdrop-filter: blur(5px);
      }
      .roster-table-wrap tbody td {
        border-bottom-color: rgba(22, 59, 80, 0.12);
      }
      .roster-table-wrap tbody tr:last-child td {
        border-bottom: 0;
      }
      .rename-row {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .rename-row input {
        min-width: 180px;
      }
      .danger-zone {
        margin-top: 14px;
        border: 1px solid rgba(182, 56, 56, 0.35);
        border-radius: 12px;
        background: rgba(255, 240, 240, 0.55);
        padding: 12px;
      }
      .danger-zone button {
        background: linear-gradient(155deg, #7d2020, #631717);
      }
      .danger-zone form {
        margin-top: 10px;
      }
      .danger-zone label {
        text-transform: none;
        letter-spacing: normal;
      }
      .section-toggle {
        margin: 0;
      }
      .section-toggle > summary {
        cursor: pointer;
        list-style: none;
        display: grid;
        grid-template-columns: 1fr;
        gap: 2px;
      }
      .section-toggle > summary::-webkit-details-marker {
        display: none;
      }
      .section-title {
        font-size: 1.3rem;
        font-weight: 700;
        color: #163b50;
      }
      .section-subtitle {
        color: #496a7b;
        font-size: 13px;
      }
      .section-body {
        margin-top: 12px;
      }
      .helper-tune {
        margin-top: 10px;
        border: 1px solid rgba(22, 59, 80, 0.12);
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.5);
        padding: 10px;
      }
      .helper-tune summary {
        cursor: pointer;
        font-weight: 700;
        color: #1b4258;
      }
      .helper-tune .hint {
        margin: 6px 0 8px 0;
      }
      .helper-grid {
        display: grid;
        gap: 8px;
      }
      .helper-grid textarea {
        min-height: 70px;
      }
      .helper-grid button {
        width: fit-content;
      }
      .helper-defaults {
        margin-top: 8px;
      }
    </style>
  </head>
  <body class="glass-theme teacher-comfort">
    {% load hub_extras %}
    <a class="skip-link" href="#main-content">Skip to main content</a>
    <div class="shell">
      <main id="main-content">
        <div class="top">
          <div>
            <div class="muted navline">
              <a href="/teach">Teacher</a> · <a href="/teach/lessons?class_id={{ classroom.id }}">Lesson tracker</a> · <a href="/teach/assets">Lesson assets</a>
              {% if request.user.is_superuser %} · <a href="/admin/">Admin</a>{% endif %} · <a href="/teach/logout">Log out</a>
            </div>
            <h1>{{ classroom.name }}</h1>
            <div class="muted">
              Join code <span class="pill">{{ classroom.join_code }}</span>
              <button type="button" class="inline-copy" data-copy-value="{{ classroom.join_code }}">Copy</button>
              · <a href="/teach/class/{{ classroom.id }}/join-card" target="_blank" rel="noopener">Printable join card</a>
              · Students {{ student_count }}
              · Status {% if classroom.is_locked %}<span class="state-pill state-pill--locked">Locked</span>{% else %}<span class="state-pill state-pill--open">Open</span>{% endif %}
            </div>
            <div id="copy-status" class="muted copy-status" role="status" aria-live="polite"></div>
          </div>
          <div class="btnline">
            <form method="post" action="/teach/class/{{ classroom.id }}/toggle-lock">
              {% csrf_token %}
              <button type="submit">{% if classroom.is_locked %}Unlock{% else %}Lock{% endif %}</button>
            </form>
            <form method="post" action="/teach/class/{{ classroom.id }}/rotate-code">
              {% csrf_token %}
              <button type="submit">Rotate code</button>
            </form>
          </div>
        </div>

        <div class="card">
          {% if notice %}
            <p class="notice" style="margin:0 0 12px 0;">{{ notice }}</p>
          {% endif %}
          {% if error %}
            <p class="error" style="margin:0 0 12px 0;">{{ error }}</p>
          {% endif %}
          <details class="section-toggle">
            <summary>
              <span class="section-title">Roster</span>
              <span class="section-subtitle">Rename students quickly. Reset roster between drop-in cohorts.</span>
            </summary>
            <div class="section-body">
              {% if students %}
                <div class="roster-table-wrap">
                  <table>
                    <thead>
                      <tr>
                        <th scope="col">Student</th>
                        <th scope="col">Return code</th>
                        <th scope="col">Submissions</th>
                        <th scope="col"><span class="visually-hidden">Actions</span></th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for st in students %}
                        <tr>
                          <td><strong>{{ st.display_name }}</strong></td>
                          <td>
                            <span class="pill">{{ st.return_code }}</span>
                            <button type="button" class="inline-copy" data-copy-value="{{ st.return_code }}">Copy</button>
                          </td>
                          <td class="muted mini">{{ submission_counts_by_student|get_item:st.id|default:0 }}</td>
                          <td>
                            <form method="post" action="/teach/class/{{ classroom.id }}/rename-student" class="rename-row">
                              {% csrf_token %}
                              <input type="hidden" name="student_id" value="{{ st.id }}" />
                              <input name="display_name" value="{{ st.display_name }}" maxlength="80" />
                              <button type="submit">Rename</button>
                            </form>
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% else %}
                <p class="muted" style="margin-top:12px">No students in roster yet.</p>
              {% endif %}

              <div class="danger-zone">
                <strong>Reset roster</strong>
                <p class="muted mini" style="margin:6px 0 0 0;">
                  This removes all students in this class and deletes their submissions. Active student sessions are invalidated immediately.
                </p>
                <form method="post" action="/teach/class/{{ classroom.id }}/reset-roster" onsubmit="return confirm('Reset roster for this class? This deletes students and submissions.');">
                  {% csrf_token %}
                  <label style="display:flex; align-items:center; gap:8px; margin-top:0;">
                    <input type="checkbox" name="rotate_code" value="1" checked style="width:auto; margin:0;" />
                    Rotate class join code after reset
                  </label>
                  <button type="submit">Reset roster now</button>
                </form>
              </div>
            </div>
          </details>
        </div>

        <div class="card">
          <details class="section-toggle">
            <summary>
              <span class="section-title">Lesson Tracker</span>
              <span class="section-subtitle">Course/lesson links with submission coverage</span>
            </summary>
            <div class="section-body">
              {% if lesson_rows %}
                <div class="lesson-table-wrap">
                  <table>
                    <thead>
                      <tr>
                        <th scope="col">Module</th>
                        <th scope="col">Lesson</th>
                        <th scope="col">Dropboxes</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for row in lesson_rows %}
                        <tr class="lesson-row">
                      <td class="module-cell"><strong>{{ row.module.title }}</strong></td>
                      <td class="lesson-cell">
                        <strong><a href="{{ row.lesson_url }}" target="_blank" rel="noopener">{{ row.lesson_title }}</a></strong>
                        <div class="muted mini">{{ row.course_slug }} / {{ row.lesson_slug }}</div>
                        <a class="quick" href="/teach/videos?class_id={{ classroom.id }}&course_slug={{ row.course_slug }}&lesson_slug={{ row.lesson_slug }}">Manage videos</a>
                        <a class="quick" href="/teach/assets?folder_id=0&course_slug={{ row.course_slug }}&lesson_slug={{ row.lesson_slug }}&status=all">Manage assets</a>
                        {% if row.review_url %}
                          <a class="quick" href="{{ row.review_url }}">{{ row.review_label }}</a>
                        {% endif %}
                        {% if row.teacher_material_html %}
                          <details class="teacher-note">
                            <summary>Teacher notes</summary>
                            <div class="teacher-note-body">{{ row.teacher_material_html|safe }}</div>
                          </details>
                        {% endif %}
                        <div class="release-box">
                          {% with release=row.release_state %}
                            <div class="release-status">
                              Release:
                              {% if release.is_locked %}
                                <span class="state-pill state-pill--locked">Locked</span>
                              {% else %}
                                <span class="state-pill state-pill--open">Open</span>
                              {% endif %}
                              {% if release.available_on %}
                                · Date <strong>{{ release.available_on|date:"M j, Y" }}</strong>
                              {% endif %}
                              {% if release.has_override %}
                                · Override active
                              {% else %}
                                · Content default
                              {% endif %}
                            </div>
                            <div class="release-actions">
                              <form method="post" action="/teach/lessons/release">
                                {% csrf_token %}
                                <input type="hidden" name="class_id" value="{{ classroom.id }}" />
                                <input type="hidden" name="course_slug" value="{{ row.course_slug }}" />
                                <input type="hidden" name="lesson_slug" value="{{ row.lesson_slug }}" />
                                <input type="hidden" name="action" value="set_date" />
                                <input type="hidden" name="return_to" value="/teach/class/{{ classroom.id }}" />
                                <input type="date" name="available_on" value="{% if release.override_available_on %}{{ release.override_available_on|date:'Y-m-d' }}{% endif %}" />
                                <button type="submit">Set date</button>
                              </form>
                              <form method="post" action="/teach/lessons/release">
                                {% csrf_token %}
                                <input type="hidden" name="class_id" value="{{ classroom.id }}" />
                                <input type="hidden" name="course_slug" value="{{ row.course_slug }}" />
                                <input type="hidden" name="lesson_slug" value="{{ row.lesson_slug }}" />
                                <input type="hidden" name="action" value="toggle_lock" />
                                <input type="hidden" name="return_to" value="/teach/class/{{ classroom.id }}" />
                                <button type="submit">Toggle lock</button>
                              </form>
                              <form method="post" action="/teach/lessons/release">
                                {% csrf_token %}
                                <input type="hidden" name="class_id" value="{{ classroom.id }}" />
                                <input type="hidden" name="course_slug" value="{{ row.course_slug }}" />
                                <input type="hidden" name="lesson_slug" value="{{ row.lesson_slug }}" />
                                <input type="hidden" name="action" value="unlock_now" />
                                <input type="hidden" name="return_to" value="/teach/class/{{ classroom.id }}" />
                                <button type="submit">Open now</button>
                              </form>
                              <form method="post" action="/teach/lessons/release">
                                {% csrf_token %}
                                <input type="hidden" name="class_id" value="{{ classroom.id }}" />
                                <input type="hidden" name="course_slug" value="{{ row.course_slug }}" />
                                <input type="hidden" name="lesson_slug" value="{{ row.lesson_slug }}" />
                                <input type="hidden" name="action" value="reset_default" />
                                <input type="hidden" name="return_to" value="/teach/class/{{ classroom.id }}" />
                                <button type="submit">Reset default</button>
                              </form>
                            </div>
                            <details class="helper-tune">
                              <summary>
                                Helper tuning
                                {% if row.helper_tuning.has_override %}
                                  <span class="muted mini">· Custom scope active</span>
                                {% else %}
                                  <span class="muted mini">· Using lesson defaults</span>
                                {% endif %}
                              </summary>
                              <p class="muted mini hint">
                                Leave fields blank to use lesson defaults for this class.
                              </p>
                              <form method="post" action="/teach/lessons/release" class="helper-grid">
                                {% csrf_token %}
                                <input type="hidden" name="class_id" value="{{ classroom.id }}" />
                                <input type="hidden" name="course_slug" value="{{ row.course_slug }}" />
                                <input type="hidden" name="lesson_slug" value="{{ row.lesson_slug }}" />
                                <input type="hidden" name="action" value="set_helper_scope" />
                                <input type="hidden" name="return_to" value="/teach/class/{{ classroom.id }}" />

                                <label for="helper-context-{{ forloop.counter0 }}">Helper context</label>
                                <input
                                  id="helper-context-{{ forloop.counter0 }}"
                                  name="helper_context_override"
                                  value="{{ row.helper_tuning.context_value }}"
                                  maxlength="200"
                                  placeholder="{{ row.helper_tuning.default_context }}"
                                />

                                <label for="helper-topics-{{ forloop.counter0 }}">Focus topics (one per line)</label>
                                <textarea
                                  id="helper-topics-{{ forloop.counter0 }}"
                                  name="helper_topics_override"
                                >{{ row.helper_tuning.topics_value }}</textarea>

                                <label for="helper-allowed-{{ forloop.counter0 }}">Allowed topics gate (one per line)</label>
                                <textarea
                                  id="helper-allowed-{{ forloop.counter0 }}"
                                  name="helper_allowed_topics_override"
                                >{{ row.helper_tuning.allowed_topics_value }}</textarea>

                                <label for="helper-reference-{{ forloop.counter0 }}">Reference key</label>
                                <input
                                  id="helper-reference-{{ forloop.counter0 }}"
                                  name="helper_reference_override"
                                  value="{{ row.helper_tuning.reference_value }}"
                                  maxlength="200"
                                  placeholder="{{ row.helper_tuning.default_reference }}"
                                />
                                <button type="submit">Save helper tuning</button>
                              </form>
                              <div class="helper-defaults muted mini">
                                Defaults:
                                context <strong>{{ row.helper_tuning.default_context }}</strong>
                                {% if row.helper_tuning.default_topics %}
                                  · topics {{ row.helper_tuning.default_topics|join:", " }}
                                {% endif %}
                                {% if row.helper_tuning.default_allowed_topics %}
                                  · allowed {{ row.helper_tuning.default_allowed_topics|join:", " }}
                                {% endif %}
                              </div>
                            </details>
                          {% endwith %}
                        </div>
                      </td>
                      <td class="dropbox-cell">
                        {% if row.dropboxes %}
                          {% for dropbox in row.dropboxes %}
                            <div class="dropbox">
                              <div><a href="/teach/material/{{ dropbox.id }}/submissions">{{ dropbox.title }}</a></div>
                              <div class="muted mini">Submitted {{ dropbox.submitted }} / {{ student_count }} · Missing {{ dropbox.missing }}{% if dropbox.last_uploaded_at %} · Latest {{ dropbox.last_uploaded_at }}{% endif %}</div>
                              <div class="actions">
                                <a href="/teach/material/{{ dropbox.id }}/submissions">All</a>
                                <a href="/teach/material/{{ dropbox.id }}/submissions?show=missing">Missing</a>
                                <a href="/teach/material/{{ dropbox.id }}/submissions?download=zip_latest">ZIP latest</a>
                              </div>
                            </div>
                          {% endfor %}
                        {% else %}
                          <span class="muted mini">No upload dropbox in this module.</span>
                        {% endif %}
                      </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% else %}
                <p class="muted" style="margin-top:12px">No course lesson links detected in this class yet.</p>
              {% endif %}
            </div>
          </details>
        </div>

        <div class="card">
          <details class="section-toggle">
            <summary>
              <span class="section-title">Module Editor</span>
              <span class="section-subtitle">Order matters. Keep it predictable.</span>
            </summary>
            <div class="section-body">
              <div style="max-width:520px">
                <form method="post" action="/teach/class/{{ classroom.id }}/add-module">
                  {% csrf_token %}
                  <label for="module-title">New module title</label>
                  <input id="module-title" name="title" placeholder="e.g., Session 5 — Scratch Motion + Loops" />
                  <button type="submit" style="margin-top:10px">Add module</button>
                </form>
              </div>

              {% if modules %}
                {% for m in modules %}
                  <div class="module">
                    <div class="row">
                      <div>
                        <strong>{{ m.title }}</strong>
                        <div class="muted mini">{{ m.materials.all|length }} materials</div>
                      </div>
                      <div class="btnline">
                        <form method="post" action="/teach/class/{{ classroom.id }}/move-module">
                          {% csrf_token %}
                          <input type="hidden" name="module_id" value="{{ m.id }}" />
                          <input type="hidden" name="direction" value="up" />
                          <button type="submit" aria-label="Move module {{ m.title }} up">↑</button>
                        </form>
                        <form method="post" action="/teach/class/{{ classroom.id }}/move-module">
                          {% csrf_token %}
                          <input type="hidden" name="module_id" value="{{ m.id }}" />
                          <input type="hidden" name="direction" value="down" />
                          <button type="submit" aria-label="Move module {{ m.title }} down">↓</button>
                        </form>
                        <a href="/teach/module/{{ m.id }}">Open</a>
                      </div>
                    </div>

                    {% if m.materials.all %}
                      {% for mat in m.materials.all %}
                        <div class="mat">
                          <div class="row">
                            <div>
                              <strong>{{ mat.title }}</strong>
                              <div class="muted mini">Type: {{ mat.type }}</div>
                            </div>
                            <div class="muted mini">
                              {% if mat.type == 'upload' %}
                                Submitted: {{ submission_counts|get_item:mat.id|default:0 }} / {{ student_count }} · <a href="/teach/material/{{ mat.id }}/submissions">Submissions</a>
                              {% endif %}
                            </div>
                          </div>
                          {% if mat.type == 'link' and mat.url %}
                            <div class="muted mini"><a href="{{ mat.url }}" target="_blank" rel="noopener">Open link</a></div>
                          {% elif mat.type == 'text' and mat.body %}
                            <pre style="margin-top:8px;">{{ mat.body|truncatechars:280 }}</pre>
                          {% elif mat.type == 'upload' %}
                            <div class="muted mini">Accepted: {{ mat.accepted_extensions|default:'.sb3' }} · Max {{ mat.max_upload_mb }}MB</div>
                          {% endif %}
                        </div>
                      {% endfor %}
                    {% else %}
                      <div class="muted mini" style="margin-top:10px">No materials yet.</div>
                    {% endif %}
                  </div>
                {% endfor %}
              {% else %}
                <p class="muted" style="margin-top:12px">No modules yet.</p>
              {% endif %}
            </div>
          </details>
        </div>
      </main>
    </div>
    <script>
      (function () {
        const status = document.getElementById("copy-status");
        const buttons = document.querySelectorAll("[data-copy-value]");
        if (!status || !buttons.length) return;
        buttons.forEach((btn) => {
          btn.addEventListener("click", async () => {
            const value = btn.getAttribute("data-copy-value") || "";
            if (!value) return;
            try {
              if (navigator.clipboard && navigator.clipboard.writeText) {
                await navigator.clipboard.writeText(value);
              } else {
                const input = document.createElement("input");
                input.value = value;
                document.body.appendChild(input);
                input.select();
                document.execCommand("copy");
                document.body.removeChild(input);
              }
              status.textContent = "Copied to clipboard.";
            } catch (err) {
              status.textContent = "Copy failed. Please copy manually.";
            }
          });
        });
      })();
    </script>
  </body>
</html>
