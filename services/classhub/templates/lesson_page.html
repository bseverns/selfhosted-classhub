{% load hub_extras %}
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ front_matter.title|default:lesson_slug }}</title>
    <style>
      body{font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif; max-width:960px; margin:40px auto; padding:0 16px;}
      .top{display:flex; justify-content:space-between; align-items:baseline; gap:12px; flex-wrap:wrap;}
      .muted{color:#666; font-size:14px;}
      .card{border:1px solid #ddd; border-radius:14px; padding:16px; margin-top:16px;}
      .nav{display:flex; gap:10px; flex-wrap:wrap; margin-top:16px;}
      .btn{display:inline-block; padding:8px 12px; border:1px solid #333; border-radius:10px; text-decoration:none; background:#fff;}
      .btn:visited{color:inherit;}
      h1,h2,h3{line-height:1.2;}
      code, pre{background:#f7f7f7; border-radius:10px;}
      pre{padding:12px; overflow:auto;}
      code{padding:2px 6px;}
      table{border-collapse:collapse; width:100%;}
      th,td{border:1px solid #ddd; padding:8px; text-align:left;}
      blockquote{border-left:3px solid #ddd; margin:12px 0; padding-left:12px; color:#444;}
      .video-item{border:1px solid #eee; border-radius:12px; padding:12px; margin-top:12px;}
      .video-frame{position:relative; width:100%; padding-top:56.25%; border-radius:10px; overflow:hidden; background:#f7f7f7;}
      .video-frame iframe{position:absolute; inset:0; width:100%; height:100%; border:0;}
    </style>
  </head>
  <body>
    <div class="top">
      <div>
        <div class="muted">Course: <a href="/course/{{ course_slug }}">{{ course.title|default:course_slug }}</a></div>
        <h1 style="margin:6px 0 0 0">{{ front_matter.title|default:lesson_slug }}</h1>
        {% if front_matter.makes %}
          <div class="muted">Makes: {{ front_matter.makes }}</div>
        {% endif %}
      </div>
      <div class="nav">
        <a class="btn" href="/student">Back to class</a>
        {% if prev %}
          <a class="btn" href="/course/{{ course_slug }}/{{ prev.slug }}">← Prev</a>
        {% endif %}
        {% if next %}
          <a class="btn" href="/course/{{ course_slug }}/{{ next.slug }}">Next →</a>
        {% endif %}
      </div>
    </div>

    {% if lesson_videos %}
      <div class="card">
        <h2 style="margin-top:0;">Lesson videos</h2>
        {% for video in lesson_videos %}
          <div class="video-item">
            <h3 style="margin:0 0 8px 0;">
              {% if video.id %}{{ video.id }} — {% endif %}{{ video.title }}
              {% if video.minutes %}<span class="muted">({{ video.minutes }} min)</span>{% endif %}
            </h3>
            {% if video.embed_url %}
              <div class="video-frame">
                <iframe
                  src="{{ video.embed_url }}"
                  title="{{ video.title }}"
                  loading="lazy"
                  allowfullscreen
                ></iframe>
              </div>
            {% endif %}
            {% if video.url %}
              <p style="margin:10px 0 0 0;">
                <a href="{{ video.url }}" target="_blank" rel="noopener noreferrer">Open video in a new tab</a>
              </p>
            {% endif %}
            {% if video.outcome %}
              <p class="muted" style="margin:8px 0 0 0;">After this you can: {{ video.outcome }}</p>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    {% endif %}

    {% if lesson_submission.type == "file" %}
      <div class="card">
        <h2 style="margin-top:0;">Homework dropbox</h2>
        <p class="muted" style="margin-top:8px;">
          {% if lesson_submission.accepted_exts %}
            Accepted: <strong>{{ lesson_submission.accepted_exts|join:", " }}</strong>
          {% else %}
            Accepted: <strong>.sb3</strong>
          {% endif %}
          {% if lesson_submission.naming %}
            · Suggested name: <strong>{{ lesson_submission.naming }}</strong>
          {% endif %}
        </p>

        {% if student and lesson_upload_material %}
          <div class="nav" style="margin-top:8px;">
            <a class="btn" href="/material/{{ lesson_upload_material.id }}/upload">Open dropbox</a>
            {% if lesson_upload_status %}
              <span class="muted">Uploaded {{ lesson_upload_status.count }} file{{ lesson_upload_status.count|pluralize }} · latest {{ lesson_upload_status.last_uploaded_at }}</span>
            {% endif %}
          </div>
        {% elif student %}
          <p class="muted" style="margin:8px 0 0 0;">Dropbox is not configured for this lesson yet. A teacher can re-import the course pack to enable it.</p>
        {% else %}
          <div class="nav" style="margin-top:8px;">
            <a class="btn" href="/">Join your class to upload homework</a>
          </div>
        {% endif %}
      </div>
    {% endif %}

    <div class="card">
      {{ lesson_html|safe }}
    </div>

    {{ helper_widget|safe }}

    <p class="muted">If something feels unsafe to share, keep your work private and submit only the file. You control what leaves your device.</p>
  </body>
</html>
