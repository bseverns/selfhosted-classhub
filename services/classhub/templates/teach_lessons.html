<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Teacher · Lessons</title>
    {% include "includes/glass_theme.html" %}
    <style>
      .heading h1 { margin: 6px 0 0 0; font-size: clamp(1.8rem, 2.5vw, 2.3rem); }
      .filter-form { justify-content: flex-start; }
      .filter-form label { margin: 0; align-self: center; }
      .filter-form select { width: auto; min-width: 200px; }
      .quick { margin-top: 10px; }
      .tracker-table-wrap {
        margin-top: 12px;
        border: 1px solid rgba(22, 59, 80, 0.16);
        border-radius: 14px;
        overflow: auto;
        background: rgba(255, 255, 255, 0.42);
      }
      .tracker-table-wrap table {
        margin: 0;
        min-width: 980px;
      }
      .tracker-table-wrap thead th {
        position: sticky;
        top: 0;
        z-index: 2;
        background: rgba(237, 246, 251, 0.96);
        backdrop-filter: blur(5px);
      }
      .tracker-table-wrap tbody td {
        border-bottom-color: rgba(22, 59, 80, 0.12);
      }
      .tracker-table-wrap tbody tr:last-child td {
        border-bottom: 0;
      }
      .lesson-row td {
        background: rgba(255, 255, 255, 0.2);
      }
      .lesson-row:nth-child(even) td {
        background: rgba(255, 255, 255, 0.34);
      }
      .module-cell {
        min-width: 200px;
      }
      .lesson-cell {
        min-width: 360px;
      }
      .dropbox-cell {
        min-width: 300px;
      }
      .dropbox {
        margin: 0 0 12px 0;
        padding: 10px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.4);
        border: 1px solid rgba(22, 59, 80, 0.12);
      }
      .dropbox:last-child { margin-bottom: 0; }
      .actions { margin-top: 6px; }
      .actions a { margin-right: 10px; font-size: 13px; }
      .teacher-note {
        margin-top: 10px;
        padding: 10px;
        border-radius: 12px;
        border: 1px solid rgba(22, 59, 80, 0.14);
        background: rgba(255, 255, 255, 0.42);
      }
      .teacher-note summary {
        cursor: pointer;
        font-weight: 700;
        color: #1b4258;
      }
      .teacher-note-body {
        margin-top: 8px;
      }
      .release-box {
        margin-top: 10px;
        padding: 10px;
        border-radius: 12px;
        border: 1px solid rgba(22, 59, 80, 0.14);
        background: rgba(255, 255, 255, 0.42);
      }
      .release-status {
        font-size: 13px;
        margin-bottom: 8px;
      }
      .release-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
      }
      .release-actions form {
        margin: 0;
      }
      .release-actions input[type="date"] {
        width: auto;
        min-width: 165px;
      }
      .notice {
        border: 1px solid rgba(36, 128, 66, 0.25);
        background: rgba(224, 248, 229, 0.75);
        color: #215a2f;
        border-radius: 12px;
        padding: 10px;
      }
      .error {
        border: 1px solid rgba(182, 56, 56, 0.35);
        background: rgba(255, 224, 224, 0.58);
        color: #8f2d2d;
        border-radius: 12px;
        padding: 10px;
      }
    </style>
  </head>
  <body class="glass-theme">
    <a class="skip-link" href="#main-content">Skip to main content</a>
    <div class="shell">
      <main id="main-content">
        <div class="top heading">
          <div>
            <div class="muted">
              <a href="/teach">Teacher</a>{% if request.user.is_superuser %} · <a href="/admin/">Admin</a>{% endif %} · <a href="/teach/logout">Log out</a>
            </div>
            <h1>Lesson Tracker</h1>
            <div class="muted">Focus on lesson links and submission progress.</div>
          </div>
        </div>

        <div class="card">
          {% if notice %}
            <p class="notice" style="margin:0 0 12px 0;">{{ notice }}</p>
          {% endif %}
          {% if error %}
            <p class="error" style="margin:0 0 12px 0;">{{ error }}</p>
          {% endif %}

          <form method="get" class="row filter-form">
            <label for="class_id">Class</label>
            <select name="class_id" id="class_id">
              <option value="0" {% if not selected_class_id %}selected{% endif %}>All classes</option>
              {% for classroom in classes %}
                <option value="{{ classroom.id }}" {% if selected_class_id == classroom.id %}selected{% endif %}>{{ classroom.name }}</option>
              {% endfor %}
            </select>
            <button type="submit">Apply</button>
          </form>
        </div>

        {% for group in class_rows %}
          <div class="card">
            <div class="row">
              <div>
                <h2 style="margin:0">{{ group.classroom.name }}</h2>
                <div class="muted">Join code <span class="pill">{{ group.classroom.join_code }}</span> · Students {{ group.student_count }}</div>
              </div>
              <div class="muted"><a href="/teach/class/{{ group.classroom.id }}">Open class dashboard</a></div>
            </div>

            {% if group.lesson_rows %}
              <div class="tracker-table-wrap">
                <table>
                  <thead>
                    <tr>
                      <th scope="col">Module</th>
                      <th scope="col">Lesson</th>
                      <th scope="col">Dropboxes</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for row in group.lesson_rows %}
                      <tr class="lesson-row">
                        <td class="module-cell"><strong>{{ row.module.title }}</strong></td>
                        <td class="lesson-cell">
                          <strong><a href="{{ row.lesson_url }}" target="_blank" rel="noopener">{{ row.lesson_title }}</a></strong>
                          <div class="muted">{{ row.course_slug }} / {{ row.lesson_slug }}</div>
                          <a class="quick" href="/teach/videos?class_id={{ group.classroom.id }}&course_slug={{ row.course_slug }}&lesson_slug={{ row.lesson_slug }}">Manage videos</a>
                          {% if row.review_url %}
                            <a class="quick" href="{{ row.review_url }}">{{ row.review_label }}</a>
                          {% endif %}
                          {% if row.teacher_material_html %}
                            <details class="teacher-note">
                              <summary>Teacher notes</summary>
                              <div class="teacher-note-body">{{ row.teacher_material_html|safe }}</div>
                            </details>
                          {% endif %}
                          <div class="release-box">
                            {% with release=row.release_state %}
                              <div class="release-status">
                                Release:
                                {% if release.is_locked %}
                                  <span class="state-pill state-pill--locked">Locked</span>
                                {% else %}
                                  <span class="state-pill state-pill--open">Open</span>
                                {% endif %}
                                {% if release.available_on %}
                                  · Date <strong>{{ release.available_on|date:"M j, Y" }}</strong>
                                {% endif %}
                                {% if release.has_override %}
                                  · Override active
                                {% else %}
                                  · Content default
                                {% endif %}
                              </div>
                              <div class="release-actions">
                                <form method="post" action="/teach/lessons/release">
                                  {% csrf_token %}
                                  <input type="hidden" name="class_id" value="{{ group.classroom.id }}" />
                                  <input type="hidden" name="course_slug" value="{{ row.course_slug }}" />
                                  <input type="hidden" name="lesson_slug" value="{{ row.lesson_slug }}" />
                                  <input type="hidden" name="action" value="set_date" />
                                  <input type="hidden" name="return_to" value="/teach/lessons?class_id={{ group.classroom.id }}" />
                                  <input type="date" name="available_on" value="{% if release.override_available_on %}{{ release.override_available_on|date:'Y-m-d' }}{% endif %}" />
                                  <button type="submit">Set date</button>
                                </form>
                                <form method="post" action="/teach/lessons/release">
                                  {% csrf_token %}
                                  <input type="hidden" name="class_id" value="{{ group.classroom.id }}" />
                                  <input type="hidden" name="course_slug" value="{{ row.course_slug }}" />
                                  <input type="hidden" name="lesson_slug" value="{{ row.lesson_slug }}" />
                                  <input type="hidden" name="action" value="toggle_lock" />
                                  <input type="hidden" name="return_to" value="/teach/lessons?class_id={{ group.classroom.id }}" />
                                  <button type="submit">Toggle lock</button>
                                </form>
                                <form method="post" action="/teach/lessons/release">
                                  {% csrf_token %}
                                  <input type="hidden" name="class_id" value="{{ group.classroom.id }}" />
                                  <input type="hidden" name="course_slug" value="{{ row.course_slug }}" />
                                  <input type="hidden" name="lesson_slug" value="{{ row.lesson_slug }}" />
                                  <input type="hidden" name="action" value="unlock_now" />
                                  <input type="hidden" name="return_to" value="/teach/lessons?class_id={{ group.classroom.id }}" />
                                  <button type="submit">Open now</button>
                                </form>
                                <form method="post" action="/teach/lessons/release">
                                  {% csrf_token %}
                                  <input type="hidden" name="class_id" value="{{ group.classroom.id }}" />
                                  <input type="hidden" name="course_slug" value="{{ row.course_slug }}" />
                                  <input type="hidden" name="lesson_slug" value="{{ row.lesson_slug }}" />
                                  <input type="hidden" name="action" value="reset_default" />
                                  <input type="hidden" name="return_to" value="/teach/lessons?class_id={{ group.classroom.id }}" />
                                  <button type="submit">Reset default</button>
                                </form>
                              </div>
                            {% endwith %}
                          </div>
                        </td>
                        <td class="dropbox-cell">
                          {% if row.dropboxes %}
                            {% for dropbox in row.dropboxes %}
                              <div class="dropbox">
                                <div><a href="/teach/material/{{ dropbox.id }}/submissions">{{ dropbox.title }}</a></div>
                                <div class="muted">
                                  Submitted {{ dropbox.submitted }} / {{ group.student_count }}
                                  · Missing {{ dropbox.missing }}
                                  {% if dropbox.last_uploaded_at %}· Latest {{ dropbox.last_uploaded_at }}{% endif %}
                                </div>
                                <div class="actions">
                                  <a href="/teach/material/{{ dropbox.id }}/submissions">All</a>
                                  <a href="/teach/material/{{ dropbox.id }}/submissions?show=missing">Missing</a>
                                  <a href="/teach/material/{{ dropbox.id }}/submissions?download=zip_latest">ZIP latest</a>
                                </div>
                              </div>
                            {% endfor %}
                          {% else %}
                            <span class="muted">No upload dropbox in this module.</span>
                          {% endif %}
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <p class="muted" style="margin-top:12px">No lesson links found in this class yet.</p>
            {% endif %}
          </div>
        {% endfor %}

        {% if not class_rows %}
          <div class="card">
            <p class="muted">No classes available.</p>
          </div>
        {% endif %}
      </main>
    </div>
  </body>
</html>
