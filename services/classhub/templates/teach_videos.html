<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Teacher · Lesson Videos</title>
    {% include "includes/glass_theme.html" %}
    <style>
      .shell { max-width: 1100px; }
      .top h1 { margin: 6px 0 0 0; font-size: clamp(1.85rem, 2.7vw, 2.35rem); }
      .btnline form { display: inline-block; margin: 0 6px 0 0; }
      .btnline button { padding: 8px 10px; font-size: 13px; border-radius: 10px; }
      .notice {
        margin-top: 12px;
        padding: 10px 12px;
        border: 1px solid rgba(32, 125, 82, 0.35);
        border-radius: 10px;
        background: rgba(216, 246, 231, 0.65);
        color: #1f5f45;
      }
      .error {
        margin-top: 12px;
        padding: 10px 12px;
        border: 1px solid rgba(182, 56, 56, 0.35);
        border-radius: 10px;
        background: rgba(255, 224, 224, 0.58);
        color: #8f2d2d;
      }
      .row-wrap { margin-top: 10px; }
      .row-wrap .row > div { min-width: 220px; flex: 1; }
      input[type="file"] { margin-top: 8px; }
      .status-pill {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 12px;
        border: 1px solid rgba(22, 59, 80, 0.22);
        background: rgba(255, 255, 255, 0.6);
      }
      .status-pill.live {
        border-color: rgba(32, 125, 82, 0.45);
        background: rgba(216, 246, 231, 0.7);
        color: #1f5f45;
      }
      .status-pill.draft {
        border-color: rgba(172, 112, 32, 0.45);
        background: rgba(255, 241, 213, 0.75);
        color: #8c5c19;
      }
      .row-draft td {
        opacity: 0.82;
      }
    </style>
  </head>
  <body class="glass-theme">
    <a class="skip-link" href="#main-content">Skip to main content</a>
    <div class="shell">
      <main id="main-content">
        <div class="top">
          <div>
            <div class="muted"><a href="/teach">Teacher</a> · <a href="/teach/lessons">Lesson tracker</a> · <a href="{{ class_back_link }}">Back</a></div>
            <h1>Lesson Videos</h1>
            <div class="muted">Upload or link self-hosted videos and tag them to a specific course + lesson.</div>
          </div>
        </div>

        {% if notice %}
          <div class="notice" role="status" aria-live="polite">{{ notice }}</div>
        {% endif %}
        {% if error %}
          <div class="error" role="alert" aria-live="assertive">{{ error }}</div>
        {% endif %}

        <div class="card">
          <h2 style="margin:0">Select lesson</h2>
          <form method="get" class="row row-wrap">
            {% if class_id %}
              <input type="hidden" name="class_id" value="{{ class_id }}" />
            {% endif %}
            <div>
              <label for="course_slug">Course</label>
              <select id="course_slug" name="course_slug">
                {% for course in course_rows %}
                  <option value="{{ course.course_slug }}" {% if course.course_slug == selected_course_slug %}selected{% endif %}>
                    {{ course.course_title }} ({{ course.course_slug }})
                  </option>
                {% endfor %}
              </select>
            </div>
            <div>
              <label for="lesson_slug">Lesson</label>
              <select id="lesson_slug" name="lesson_slug">
                {% for lesson in lesson_rows %}
                  <option value="{{ lesson.lesson_slug }}" {% if lesson.lesson_slug == selected_lesson_slug %}selected{% endif %}>
                    {% if lesson.session %}Session {{ lesson.session }} — {% endif %}{{ lesson.lesson_title }}
                  </option>
                {% endfor %}
              </select>
            </div>
            <div style="align-self:end">
              <button type="submit">Load lesson</button>
            </div>
          </form>
        </div>

        <div class="card">
          <div class="row">
            <h2 style="margin:0">Add video</h2>
            {% if selected_course_slug and selected_lesson_slug %}
              <div class="muted"><a href="/course/{{ selected_course_slug }}/{{ selected_lesson_slug }}" target="_blank" rel="noopener">Open lesson preview</a></div>
            {% endif %}
          </div>

          <form method="post" enctype="multipart/form-data" style="margin-top:10px; max-width:920px">
            {% csrf_token %}
            <input type="hidden" name="action" value="add" />
            <input type="hidden" name="course_slug" value="{{ selected_course_slug }}" />
            <input type="hidden" name="lesson_slug" value="{{ selected_lesson_slug }}" />
            {% if class_id %}
              <input type="hidden" name="class_id" value="{{ class_id }}" />
            {% endif %}

            <div class="row">
              <div>
                <label for="video-title">Title</label>
                <input id="video-title" name="title" placeholder="e.g., Save privately: Download to your computer" required />
              </div>
              <div style="min-width:160px; max-width:200px">
                <label for="video-minutes">Minutes</label>
                <input id="video-minutes" name="minutes" type="number" min="0" step="1" placeholder="4" />
              </div>
            </div>

            <label for="video-outcome">Outcome</label>
            <input id="video-outcome" name="outcome" placeholder="What students should be able to do after this video." />

            <label for="video-url">Video URL (self-hosted MP4/HLS or YouTube)</label>
            <input id="video-url" name="source_url" placeholder="https://lms.example.org/video/.../master.m3u8" />

            <label for="video-file">Or upload video file</label>
            <input id="video-file" name="video_file" type="file" accept="video/*,.m3u8" />
            <div class="muted">Choose URL or upload, not both. Uploaded files are streamed through Django with permission checks.</div>

            <label style="display:flex; gap:8px; align-items:center; margin-top:8px;">
              <input type="checkbox" name="is_active" value="1" checked />
              <span>Publish immediately (uncheck to save as draft)</span>
            </label>

            <button type="submit" style="margin-top:12px">Save video</button>
          </form>
        </div>

        <div class="card">
          <h2 style="margin:0">Bulk upload files</h2>
          <p class="muted" style="margin-top:8px">Upload multiple files at once and auto-create video rows for this lesson.</p>
          <form method="post" enctype="multipart/form-data" style="margin-top:10px; max-width:920px">
            {% csrf_token %}
            <input type="hidden" name="action" value="bulk_upload" />
            <input type="hidden" name="course_slug" value="{{ selected_course_slug }}" />
            <input type="hidden" name="lesson_slug" value="{{ selected_lesson_slug }}" />
            {% if class_id %}
              <input type="hidden" name="class_id" value="{{ class_id }}" />
            {% endif %}

            <label for="bulk-files">Video files</label>
            <input id="bulk-files" name="video_files" type="file" accept="video/*,.m3u8" multiple required />

            <label for="title-prefix">Optional title prefix</label>
            <input id="title-prefix" name="title_prefix" placeholder="e.g., Session 2" />

            <label style="display:flex; gap:8px; align-items:center; margin-top:8px;">
              <input type="checkbox" name="bulk_is_active" value="1" checked />
              <span>Publish immediately (uncheck to save as draft)</span>
            </label>

            <button type="submit" style="margin-top:12px">Upload files</button>
          </form>
        </div>

        <div class="card">
          <div class="row">
            <h2 style="margin:0">Tagged videos</h2>
            <div class="muted">{{ published_count }} published · {{ draft_count }} draft</div>
          </div>
          {% if lesson_video_rows %}
            <table style="margin-top:10px">
              <thead>
                <tr>
                  <th scope="col">Order</th>
                  <th scope="col">Title</th>
                  <th scope="col">Status</th>
                  <th scope="col">Source</th>
                  <th scope="col"><span class="visually-hidden">Actions</span></th>
                </tr>
              </thead>
              <tbody>
                {% for row in lesson_video_rows %}
                  <tr{% if not row.is_active %} class="row-draft"{% endif %}>
                    <td class="muted">{{ forloop.counter }}</td>
                    <td>
                      <strong>{{ row.title }}</strong>
                      <div class="muted">
                        {% if row.minutes %}{{ row.minutes }} min{% endif %}
                        {% if row.outcome %} · {{ row.outcome }}{% endif %}
                      </div>
                    </td>
                    <td>
                      {% if row.is_active %}
                        <span class="status-pill live">Published</span>
                      {% else %}
                        <span class="status-pill draft">Draft</span>
                      {% endif %}
                    </td>
                    <td class="muted">
                      {% if row.video_file %}
                        Uploaded file · <a href="/lesson-video/{{ row.id }}/stream" target="_blank" rel="noopener">Preview stream</a>
                      {% elif row.source_url %}
                        <a href="{{ row.source_url }}" target="_blank" rel="noopener">Open URL</a>
                      {% else %}
                        —
                      {% endif %}
                    </td>
                    <td>
                      <div class="btnline">
                        <form method="post">
                          {% csrf_token %}
                          <input type="hidden" name="action" value="set_active" />
                          <input type="hidden" name="course_slug" value="{{ selected_course_slug }}" />
                          <input type="hidden" name="lesson_slug" value="{{ selected_lesson_slug }}" />
                          <input type="hidden" name="video_id" value="{{ row.id }}" />
                          <input type="hidden" name="active" value="{% if row.is_active %}0{% else %}1{% endif %}" />
                          {% if class_id %}<input type="hidden" name="class_id" value="{{ class_id }}" />{% endif %}
                          <button type="submit">{% if row.is_active %}Unpublish{% else %}Publish{% endif %}</button>
                        </form>
                        <form method="post">
                          {% csrf_token %}
                          <input type="hidden" name="action" value="move" />
                          <input type="hidden" name="course_slug" value="{{ selected_course_slug }}" />
                          <input type="hidden" name="lesson_slug" value="{{ selected_lesson_slug }}" />
                          <input type="hidden" name="video_id" value="{{ row.id }}" />
                          <input type="hidden" name="direction" value="up" />
                          {% if class_id %}<input type="hidden" name="class_id" value="{{ class_id }}" />{% endif %}
                          <button type="submit" aria-label="Move video {{ row.title }} up">↑</button>
                        </form>
                        <form method="post">
                          {% csrf_token %}
                          <input type="hidden" name="action" value="move" />
                          <input type="hidden" name="course_slug" value="{{ selected_course_slug }}" />
                          <input type="hidden" name="lesson_slug" value="{{ selected_lesson_slug }}" />
                          <input type="hidden" name="video_id" value="{{ row.id }}" />
                          <input type="hidden" name="direction" value="down" />
                          {% if class_id %}<input type="hidden" name="class_id" value="{{ class_id }}" />{% endif %}
                          <button type="submit" aria-label="Move video {{ row.title }} down">↓</button>
                        </form>
                        <form method="post">
                          {% csrf_token %}
                          <input type="hidden" name="action" value="delete" />
                          <input type="hidden" name="course_slug" value="{{ selected_course_slug }}" />
                          <input type="hidden" name="lesson_slug" value="{{ selected_lesson_slug }}" />
                          <input type="hidden" name="video_id" value="{{ row.id }}" />
                          {% if class_id %}<input type="hidden" name="class_id" value="{{ class_id }}" />{% endif %}
                          <button type="submit">Delete</button>
                        </form>
                      </div>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          {% else %}
            <p class="muted" style="margin-top:10px">No videos tagged to this lesson yet.</p>
          {% endif %}
        </div>
      </main>
    </div>
  </body>
</html>
