<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Join Class</title>
    {% include "includes/glass_theme.html" %}
    <style>
      .shell {
        max-width: 760px;
      }
      .hero {
        margin-top: 6px;
        margin-bottom: 14px;
      }
      .hero h1 {
        margin: 0;
        font-size: clamp(2rem, 2.8vw, 2.6rem);
      }
      .hero p {
        margin: 8px 0 0 0;
      }
      .error {
        margin-top: 10px;
        padding: 9px 11px;
        border: 1px solid rgba(182, 56, 56, 0.35);
        border-radius: 10px;
        color: #8f2d2d;
        background: rgba(255, 224, 224, 0.55);
        font-size: 14px;
      }
      .actions {
        margin-top: 16px;
      }
      .entry-note {
        margin-top: 16px;
      }
    </style>
  </head>
  <body class="glass-theme">
    <a class="skip-link" href="#main-content">Skip to main content</a>
    <div class="shell">
      <main id="main-content">
        <div class="hero">
          <h1>Join your class</h1>
          <p class="muted">Enter the class code your teacher gives you. Pick a name your teacher will recognize.</p>
          <p class="muted">If this is the same classroom computer/browser, you can usually leave return code blank.</p>
        </div>

        <div class="card">
          <form id="join-form" novalidate>
            <label for="code">Class code</label>
            <input id="code" name="class_code" placeholder="ABCD1234" autocomplete="off" required />

            <label for="name">Your name</label>
            <input id="name" name="display_name" placeholder="Ada" autocomplete="name" required />

            <label for="return_code">Return code (optional)</label>
            <input id="return_code" name="return_code" placeholder="ABC234" autocomplete="one-time-code" />

            <div class="actions">
              <button id="join" type="submit">Join class</button>
            </div>
            <div id="msg" class="error" role="alert" aria-live="assertive" style="display:none"></div>
          </form>
        </div>

        <p class="muted entry-note">Teacher/admin? Use <a href="/teach">/teach</a> (or <a href="/admin/">/admin</a>).</p>
      </main>
    </div>

    <script>
      const msg = document.getElementById('msg');
      const showErr = (t) => { msg.textContent = t; msg.style.display = 'block'; };

      // Django CSRF: read csrftoken cookie and send it as X-CSRFToken.
      // This keeps CSRF protection enabled without requiring a full form POST.
      const getCookie = (name) => {
        const cookies = document.cookie ? document.cookie.split('; ') : [];
        for (const c of cookies) {
          const idx = c.indexOf('=');
          if (idx === -1) continue;
          const k = c.slice(0, idx);
          const v = c.slice(idx + 1);
          if (k === name) return decodeURIComponent(v);
        }
        return '';
      };

      const csrfToken = () => getCookie('csrftoken') || '';

      document.getElementById('join-form').addEventListener('submit', async (event) => {
        event.preventDefault();
        msg.style.display = 'none';
        const class_code = (document.getElementById('code').value || '').trim();
        const display_name = (document.getElementById('name').value || '').trim();
        const return_code = (document.getElementById('return_code').value || '').trim();
        const joinBtn = document.getElementById('join');
        joinBtn.disabled = true;
        joinBtn.setAttribute('aria-busy', 'true');

        try {
          const res = await fetch('/join', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': csrfToken(),
            },
            credentials: 'same-origin',
            body: JSON.stringify({ class_code, display_name, return_code })
          });

          if (!res.ok) {
            const data = await res.json().catch(() => ({}));
            const e = data.error || 'join_failed';
            if (e === 'invalid_code') return showErr('That class code is not recognized.');
            if (e === 'invalid_return_code') return showErr('That return code is not valid for this class.');
            if (e === 'class_locked') return showErr('This class is locked right now.');
            if (e === 'missing_fields') return showErr('Please enter a class code and your name.');
            if (e === 'rate_limited') return showErr('Too many join attempts. Wait a minute and try again.');
            return showErr('Could not join. Try again.');
          }

          window.location.href = '/student';
        } catch (err) {
          showErr('Network error. Please try again.');
        } finally {
          joinBtn.disabled = false;
          joinBtn.removeAttribute('aria-busy');
        }
      });
    </script>
  </body>
</html>
